<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title data-i18n="title">Website Checker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    .success { color: green; }
    .error { color: red; }
    table { border-collapse: collapse; margin-top: 1rem; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f4f4f4; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .checks-container { display: flex; gap: 2rem; }
    .checks-block { flex: 1; }
    .group-label { font-weight: bold; }
    .language-selector { margin-bottom: 1rem; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/i18next@23.10.0/dist/umd/i18next.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
</head>
<body>

  <div class="language-selector">
    <label for="language" data-i18n="language">Language</label>:
    <select id="language" onchange="changeLanguage(this.value)">
      <option value="en" data-i18n="languages.en">English</option>
      <option value="ru" data-i18n="languages.ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="es" data-i18n="languages.es">Espa√±ol</option>
      <option value="fr" data-i18n="languages.fr">Fran√ßais</option>
      <option value="de" data-i18n="languages.de">Deutsch</option>
    </select>
  </div>

  <h1>üåê <span data-i18n="title">Website Checker</span></h1>

  <input id="site" data-i18n="[placeholder]urlPlaceholder" value="https://example.com">
  <input id="depth" type="number" data-i18n="[placeholder]depthPlaceholder" value="0">
  <small data-i18n="parsingDepth">(parsing depth)</small>

  <div class="checks-container">
    <div class="checks-block">
      <h3 data-i18n="includeChecks">‚úÖ Include Checks</h3>
      <div id="include-checks"></div>
    </div>

    <div class="checks-block">
      <h3 data-i18n="excludeChecks">‚ùå Exclude Checks</h3>
      <div id="exclude-checks"></div>
    </div>
  </div>

  <br>
  <button onclick="startAudit()" data-i18n="startAudit">üöÄ Start Audit</button>

  <pre id="progress"></pre>
  <div id="result"></div>
  <button id="csv-btn" onclick="downloadCSV()" style="display:none;" data-i18n="downloadCSV">üì• Download CSV</button>

<script>
  // Initialize i18next
  async function initializeI18n() {
    await i18next
      .use(i18nextBrowserLanguageDetector)
      .init({
        fallbackLng: 'en',
        debug: true,
        interpolation: {
          escapeValue: false
        },
        resources: {
          en: {
            translation: await fetch('/translations/en.json').then(res => res.json())
          },
          ru: {
            translation: await fetch('/translations/ru.json').then(res => res.json())
          }
        }
      });

    updateContent();
    fetchChecks();
    
    // Set initial language in select
    document.getElementById('language').value = i18next.language;
  }

  function updateContent() {
    // Update regular content
    document.querySelectorAll('[data-i18n]').forEach(element => {
      const key = element.getAttribute('data-i18n');
      if (key.startsWith('[')) {
        // Handle attributes like [placeholder]
        const match = key.match(/\[(.*?)\](.*)/);
        if (match) {
          const [, attr, tKey] = match;
          element.setAttribute(attr, i18next.t(tKey));
        }
      } else {
        element.textContent = i18next.t(key);
      }
    });

    // Update document title
    document.title = i18next.t('title');
  }

  function changeLanguage(lng) {
    i18next.changeLanguage(lng).then(() => {
      updateContent();
    });
  }

  async function fetchChecks () {
    const checks = await fetch('/checks').then(res => res.json())
    renderChecks(checks, 'include-checks', 'include')
    renderChecks(checks, 'exclude-checks', 'exclude')
  }

  function renderChecks (checks, containerId, type) {
    const container = document.getElementById(containerId)
    container.innerHTML = ''; // Clear existing content
    const groups = {}

    checks.forEach(check => {
      const [group, name] = check.split(/[/\\]/)
      if (!groups[group]) groups[group] = []
      groups[group].push(check)
    })

    Object.keys(groups).forEach(group => {
      const groupDiv = document.createElement('div')
      groupDiv.innerHTML = `<label class="group-label">
        <input type="checkbox" onchange="toggleGroup(this, '${type}')"> ${group}
      </label>`
      groups[group].forEach(check => {
        groupDiv.innerHTML += `
          <div>
            <label><input type="checkbox" name="${type}" value="${check}"> ${check}</label>
          </div>`
      })
      container.appendChild(groupDiv)
    })
  }

  function toggleGroup (checkbox, type) {
    const checks = checkbox.closest('div').querySelectorAll(`input[name="${type}"]`)
    checks.forEach(chk => chk.checked = checkbox.checked)
  }

  async function startAudit () {
    const site = document.getElementById('site').value
    const depth = document.getElementById('depth').value
    const include = Array.from(document.querySelectorAll('input[name="include"]:checked')).map(i => i.value)
    const exclude = Array.from(document.querySelectorAll('input[name="exclude"]:checked')).map(i => i.value)

    document.getElementById('progress').textContent = i18next.t('auditStarted') + '\n'
    document.getElementById('result').innerHTML = ''
    document.getElementById('csv-btn').style.display = 'none'

    const startTime = Date.now()
    const response = await fetch(`/audit?site=${encodeURIComponent(site)}&depth=${depth}&include=${include}&exclude=${exclude}`)
    const reader = response.body.getReader()
    const decoder = new TextDecoder()
    let progressText = ''
    let resultJson = ''
    let progressEnded = false

    while (true) {
      const { done, value } = await reader.read()
      if (done) break
      const chunk = decoder.decode(value, { stream: true })
      
      if (!progressEnded) {
        const endMarker = '==== Audit Complete ===='
        if (chunk.includes(endMarker)) {
          progressEnded = true
          const [progress, json] = chunk.split(endMarker)
          progressText += progress
          document.getElementById('progress').textContent = progressText
          resultJson = json.trim()
        } else {
          progressText += chunk
          document.getElementById('progress').textContent = progressText
        }
      } else {
        resultJson += chunk
      }
    }

    try {
      const data = JSON.parse(resultJson)
      const totalTime = ((Date.now() - startTime) / 1000).toFixed(2)
      renderResults(data, totalTime)
    } catch (error) {
      console.error('Failed to parse results:', error)
      document.getElementById('result').innerHTML = `<p class="error">Error parsing results: ${error.message}</p>`
    }
  }

  let lastResults = []

  function escapeHtml (text) {
    if (text === undefined || text === null) return ''
    return String(text).replace(/[&<>"']/g, char => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[char]
    ))
  }

  function sortResults (a, b) {
    const order = {'site-wide': 0, 'final': 2}
    const aOrder = order[a.pageUrl] !== undefined ? order[a.pageUrl] : 1
    const bOrder = order[b.pageUrl] !== undefined ? order[b.pageUrl] : 1
    if (aOrder !== bOrder) return aOrder - bOrder
    return a.pageUrl.localeCompare(b.pageUrl) ||
           a.group.localeCompare(b.group) ||
           a.checkName.localeCompare(b.checkName)
  }

  function renderResults (data, totalTime) {
    if (!data || !Array.isArray(data.results)) {
      document.getElementById('result').innerHTML = `<p class="error">Invalid results format</p>`
      return
    }

    lastResults = data.results.sort(sortResults)
    const resultDiv = document.getElementById('result')
    let html = `
      <h2>${i18next.t('auditSummary', { time: totalTime })}</h2>
      <p class="success">${i18next.t('passed', { count: data.passedCount })}</p>
      <p class="error">${i18next.t('failed', { count: data.failedCount })}</p>

      <table>
        <thead>
          <tr>
            <th>${i18next.t('tableHeaders.pageUrl')}</th>
            <th>${i18next.t('tableHeaders.group')}</th>
            <th>${i18next.t('tableHeaders.check')}</th>
            <th>${i18next.t('tableHeaders.status')}</th>
            <th>${i18next.t('tableHeaders.duration')}</th>
            <th>${i18next.t('tableHeaders.recommended')}</th>
            <th>${i18next.t('tableHeaders.actual')}</th>
            <th>${i18next.t('tableHeaders.errors')}</th>
          </tr>
        </thead>
        <tbody>`
    
    lastResults.forEach(r => {
      const details = r.details || {}
      html += `
        <tr>
          <td>${escapeHtml(r.pageUrl)}</td>
          <td>${escapeHtml(r.group)}</td>
          <td>${escapeHtml(r.checkName)}</td>
          <td>${r.status ? '‚úÖ' : '‚ùå'}</td>
          <td>${r.duration}</td>
          <td>${escapeHtml(details.recommended)}</td>
          <td>${escapeHtml(details.actual)}</td>
          <td>${escapeHtml((details.errors || []).map(e => e.message || e).join('; '))}</td>
        </tr>`
    })
    html += '</tbody></table>'
    resultDiv.innerHTML = html
    document.getElementById('csv-btn').style.display = 'inline-block'
  }

  function downloadCSV () {
    const headers = [
      i18next.t('tableHeaders.pageUrl'),
      i18next.t('tableHeaders.group'),
      i18next.t('tableHeaders.check'),
      i18next.t('tableHeaders.status'),
      i18next.t('tableHeaders.duration'),
      i18next.t('tableHeaders.recommended'),
      i18next.t('tableHeaders.actual'),
      i18next.t('tableHeaders.errors')
    ]
    const rows = lastResults.map(r => [
      r.pageUrl, r.group, r.checkName,
      r.status ? i18next.t('passed', { count: 1 }) : i18next.t('failed', { count: 1 }),
      r.duration, `"${r.details.recommended}"`,
      `"${r.details.actual}"`,
      `"${r.details.errors.map(e => e.message).join('; ')}"`
    ])
    const csvContent = '\uFEFF' + [headers, ...rows].map(e => e.join(',')).join('\n')
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    link.href = URL.createObjectURL(blob)
    link.download = 'audit_results.csv'
    link.click()
  }

  // Start initialization
  initializeI18n();
</script>

</body>
</html>
